<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraNotes</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-body: #ffffff;
            --border-color: #e0e0e0;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --yellow-accent: #fbbc04;
            --blue-auth: #1a73e8;
            --error-color: #d93025;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Roboto', sans-serif; margin: 0; background-color: var(--bg-body); color: var(--text-primary); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* --- AUTH SCREEN --- */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 5000;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .auth-card {
            width: 350px; padding: 40px; border: 1px solid #dadce0; border-radius: 8px; text-align: center;
        }
        .auth-card h2 { margin-bottom: 20px; color: var(--text-primary); }
        
        .input-group { margin-bottom: 15px; }
        .auth-card input {
            width: 100%; padding: 13px 15px; margin-bottom: 10px; border: 1px solid #dadce0; border-radius: 4px; font-size: 16px;
        }
        
        /* Email Button */
        .auth-btn {
            width: 100%; padding: 12px; background: var(--blue-auth); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;
        }
        .auth-btn:hover { background: #1557b0; }

        /* Divider */
        .divider {
            margin: 20px 0; position: relative; text-align: center;
        }
        .divider::before {
            content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: #dadce0; z-index: -1;
        }
        .divider span {
            background: white; padding: 0 10px; color: #5f6368; font-size: 14px;
        }

        /* Google Button */
        .google-btn {
            width: 100%; padding: 12px; background: white; color: #3c4043; 
            border: 1px solid #dadce0; border-radius: 4px; 
            font-weight: 500; cursor: pointer; font-size: 14px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: background 0.2s;
        }
        .google-btn:hover { background: #f8f9fa; border-color: #d2e3fc; }
        .google-btn img { width: 18px; height: 18px; }

        .switch-text { margin-top: 20px; font-size: 14px; color: var(--blue-auth); cursor: pointer; user-select: none; }
        .switch-text:hover { text-decoration: underline; }

        .error-msg { 
            color: var(--error-color); font-size: 14px; margin-bottom: 15px; display: none; 
            background: #fce8e6; padding: 10px; border-radius: 4px; text-align: left;
        }

        /* --- MAIN APP --- */
        #app-container { display: none; flex-direction: column; height: 100%; }

        header {
            display: flex; align-items: center; padding: 8px 20px; border-bottom: 1px solid var(--border-color);
            background: white; z-index: 100; height: 64px; justify-content: space-between;
        }
        .logo-area { display: flex; align-items: center; font-size: 22px; color: var(--text-secondary); }
        .logo-icon { color: var(--yellow-accent); margin-right: 10px; }
        
        .user-controls { display: flex; align-items: center; gap: 15px; }
        .user-email { font-size: 14px; color: var(--text-secondary); }
        .logout-btn { border: 1px solid #dadce0; background: transparent; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .logout-btn:hover { background: #f1f3f4; }

        .app-body { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 80px; padding-top: 20px; display: flex; flex-direction: column; align-items: center; }
        .nav-item {
            width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin-bottom: 15px; cursor: pointer; color: var(--text-secondary);
        }
        .nav-item.active { background-color: #feefc3; color: #202124; }
        .nav-item i { font-size: 1.3rem; }

        .main-content { flex-grow: 1; overflow-y: auto; padding: 30px 50px; }
        
        .input-wrapper { display: flex; justify-content: center; margin-bottom: 40px; }
        .note-form {
            background: #fff; box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15);
            border-radius: 8px; width: 600px; max-width: 100%; padding: 12px 16px; transition: background 0.3s;
        }
        .note-form input, .note-form textarea { width: 100%; border: none; background: transparent; font-family: 'Roboto', sans-serif; resize: none; }
        #form-title { font-weight: 500; font-size: 1rem; margin-bottom: 10px; display: none; }
        .form-tools { display: none; justify-content: space-between; align-items: center; margin-top: 12px; }

        .notes-grid { column-count: 4; column-gap: 15px; margin-bottom: 40px; }
        @media (max-width: 1100px) { .notes-grid { column-count: 3; } }
        @media (max-width: 800px) { .notes-grid { column-count: 2; } }
        @media (max-width: 550px) { .notes-grid { column-count: 1; } .sidebar { display: none; } }

        .note-card {
            background-color: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px;
            margin-bottom: 15px; break-inside: avoid; position: relative; transition: box-shadow 0.2s;
        }
        .note-card:hover { box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15); }
        .card-title { font-weight: 500; margin-bottom: 8px; font-size: 1.1rem; }
        .card-text { font-size: 0.95rem; white-space: pre-wrap; line-height: 1.4; }
        .card-actions { opacity: 0; display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; transition: opacity 0.2s; }
        .note-card:hover .card-actions { opacity: 1; }
        .icon-btn { background: transparent; border: none; cursor: pointer; color: var(--text-secondary); }
        .icon-btn:hover { color: var(--text-primary); }
        .color-palette { display: flex; gap: 5px; }
        .color-dot { width: 20px; height: 20px; border-radius: 50%; border: 1px solid #ddd; cursor: pointer; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="logo-area" style="margin-bottom: 20px;">
            <i class="far fa-lightbulb logo-icon" style="font-size: 2rem;"></i>
            <span style="font-size: 1.5rem;">UltraNotes</span>
        </div>
        <div class="auth-card">
            <h2 id="auth-title">Sign In</h2>
            
            <p class="error-msg" id="auth-error"></p>

            <button class="google-btn" onclick="googleLogin()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="G">
                Sign in with Google
            </button>

            <div class="divider"><span>OR</span></div>

            <input type="email" id="auth-email" placeholder="Email">
            <input type="password" id="auth-pass" placeholder="Password">
            <button class="auth-btn" onclick="handleAuth()" id="auth-action-btn">Sign In</button>
            
            <div class="switch-text" onclick="toggleAuthMode()" id="auth-toggle">Need an account? Register</div>
        </div>
    </div>

    <div id="app-container">
        <header>
            <div class="logo-area">
                <i class="far fa-lightbulb logo-icon"></i>
                <span>UltraNotes</span>
            </div>
            <div class="user-controls">
                <span class="user-email" id="display-email"></span>
                <button class="logout-btn" onclick="logout()">Sign Out</button>
            </div>
        </header>

        <div class="app-body">
            <div class="sidebar">
                <div class="nav-item active"><i class="far fa-lightbulb"></i></div>
            </div>

            <div class="main-content">
                <div class="input-wrapper">
                    <div class="note-form" id="createForm" style="background-color: #fff;">
                        <input type="text" id="form-title" placeholder="Title">
                        <textarea id="form-text" placeholder="Take a note..." rows="1"></textarea>
                        <div class="form-tools" id="form-tools">
                            <div class="color-palette" id="form-palette"></div>
                            <button style="border:none; background:transparent; font-weight:bold; cursor:pointer;" onclick="addNote()">Close</button>
                        </div>
                    </div>
                </div>

                <div class="notes-grid" id="notes-container"></div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. CONFIGURATION 
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyDgBiiWC96zjnfTR4mUlRWr-MaEx3ZoTu4",
          authDomain: "ultranotes-5b5b8.firebaseapp.com",
          projectId: "ultranotes-5b5b8",
          storageBucket: "ultranotes-5b5b8.firebasestorage.app",
          messagingSenderId: "665253373804",
          appId: "1:665253373804:web:1d977fbda246fc0c933549",
          measurementId: "G-RFP81L8TTV"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ==========================================
        // 2. LOGIC
        // ==========================================
        let currentUser = null;
        let unsubscribeNotes = null; 
        let isRegistering = false; 
        let formColor = '#ffffff';
        const colors = ['#ffffff', '#f28b82', '#fbbc04', '#fff475', '#ccff90', '#a7ffeb', '#cbf0f8', '#aecbfa', '#d7aefb'];

        const authOverlay = document.getElementById('auth-overlay');
        const appContainer = document.getElementById('app-container');
        const notesContainer = document.getElementById('notes-container');
        const createForm = document.getElementById('createForm');
        const formTitle = document.getElementById('form-title');
        const formText = document.getElementById('form-text');
        const formTools = document.getElementById('form-tools');

        // --- AUTH LOGIC ---

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('display-email').innerText = user.email;
                authOverlay.style.display = 'none';
                appContainer.style.display = 'flex';
                subscribeToNotes();
            } else {
                currentUser = null;
                authOverlay.style.display = 'flex';
                appContainer.style.display = 'none';
                if(unsubscribeNotes) unsubscribeNotes();
            }
        });

        // NEW: Google Login Function
        function googleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            const errorDisplay = document.getElementById('auth-error');
            errorDisplay.style.display = 'none';

            auth.signInWithPopup(provider)
                .then((result) => {
                    // Successful login is handled automatically by onAuthStateChanged
                    console.log("Google Login Success", result.user);
                })
                .catch((error) => {
                    console.error("Google Login Error", error);
                    errorDisplay.innerText = error.message;
                    errorDisplay.style.display = 'block';
                });
        }

        function toggleAuthMode() {
            isRegistering = !isRegistering;
            const title = document.getElementById('auth-title');
            const btn = document.getElementById('auth-action-btn');
            const toggle = document.getElementById('auth-toggle');
            const error = document.getElementById('auth-error');

            if (isRegistering) {
                title.innerText = 'Register';
                btn.innerText = 'Register';
                toggle.innerText = 'Have an account? Sign In';
            } else {
                title.innerText = 'Sign In';
                btn.innerText = 'Sign In';
                toggle.innerText = 'Need an account? Register';
            }
            error.style.display = 'none';
        }

        function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const errorDisplay = document.getElementById('auth-error');
            
            errorDisplay.style.display = 'none';

            if (isRegistering) {
                auth.createUserWithEmailAndPassword(email, pass)
                    .catch(err => {
                        if (err.code === 'auth/email-already-in-use') {
                            errorDisplay.innerHTML = "<b>Account exists!</b><br>Please click 'Sign In' at the bottom.";
                        } else if (err.code === 'auth/weak-password') {
                            errorDisplay.innerText = "Password should be at least 6 characters.";
                        } else {
                            errorDisplay.innerText = err.message;
                        }
                        errorDisplay.style.display = 'block';
                    });
            } else {
                auth.signInWithEmailAndPassword(email, pass)
                    .catch(err => {
                        errorDisplay.innerText = "Incorrect email or password.";
                        errorDisplay.style.display = 'block';
                    });
            }
        }

        function logout() {
            auth.signOut();
        }

        // --- DATABASE LOGIC ---

        function subscribeToNotes() {
            const q = db.collection('notes')
                        .where('uid', '==', currentUser.uid)
                        .orderBy('createdAt', 'desc');

            unsubscribeNotes = q.onSnapshot((snapshot) => {
                notesContainer.innerHTML = ''; 
                snapshot.forEach((doc) => {
                    renderNote(doc.id, doc.data());
                });
            });
        }

        function addNote() {
            const title = formTitle.value.trim();
            const text = formText.value.trim();

            if (title || text) {
                db.collection('notes').add({
                    uid: currentUser.uid,
                    title: title,
                    text: text,
                    color: formColor,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            resetForm();
        }

        function deleteNote(id) {
            db.collection('notes').doc(id).delete();
        }

        // --- UI LOGIC ---

        function renderNote(id, data) {
            const div = document.createElement('div');
            div.className = 'note-card';
            div.style.backgroundColor = data.color;
            div.style.borderColor = data.color === '#ffffff' ? '#e0e0e0' : data.color;

            div.innerHTML = `
                ${data.title ? `<div class="card-title">${data.title}</div>` : ''}
                <div class="card-text">${data.text}</div>
                <div class="card-actions">
                    <button class="icon-btn" onclick="deleteNote('${id}')"><i class="fas fa-trash"></i></button>
                </div>
            `;
            notesContainer.appendChild(div);
        }

        formText.addEventListener('click', () => {
            formTitle.style.display = 'block';
            formTools.style.display = 'flex';
            formText.rows = 3;
        });

        function resetForm() {
            formTitle.value = '';
            formText.value = '';
            formTitle.style.display = 'none';
            formTools.style.display = 'none';
            formText.rows = 1;
            formColor = '#ffffff';
            createForm.style.backgroundColor = '#ffffff';
        }

        const palette = document.getElementById('form-palette');
        colors.forEach(c => {
            const dot = document.createElement('div');
            dot.className = 'color-dot';
            dot.style.background = c;
            dot.onclick = () => {
                formColor = c;
                createForm.style.backgroundColor = c;
            };
            palette.appendChild(dot);
        });

        document.addEventListener('click', (e) => {
            if (!createForm.contains(e.target) && formTools.style.display === 'flex') {
                addNote();
            }
        });

    </script>
</body>
</html>
